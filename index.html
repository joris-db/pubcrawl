<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>De Grote DD Pub Crawl</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DD PubCrawl">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.15);
        }

        body {
            background: #020617;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .mesh-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(at 0% 0%, rgba(124, 58, 237, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(245, 158, 11, 0.1) 0px, transparent 50%);
            filter: blur(80px);
        }

        .glass {
            background: var(--glass);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
        }

        .pub-card {
            height: 160px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.3s ease;
        }

        .pub-card:active { transform: scale(0.95); }

        .pub-card.revealed {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(236, 72, 153, 0.2));
            border-color: rgba(245, 158, 11, 0.4);
        }

        .hidden-view { display: none !important; }

        .digital-clock {
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        .face-rating-img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            filter: grayscale(100%) opacity(30%);
            transition: all 0.2s ease;
        }

        .face-rating-img.active {
            filter: grayscale(0%) opacity(100%);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
            transform: scale(1.2);
            border: 2px solid #f59e0b;
        }

        #reveal-overlay .route-box {
            animation: slideUp 0.5s ease-out forwards;
            opacity: 0;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Result Popup Animations */
        .popup-scale {
            animation: popupScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes popupScale {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="mesh-bg"></div>

    <main class="max-w-xl mx-auto p-6 min-h-screen relative z-10">
        <!-- Header -->
        <header id="main-header" class="text-center py-8 mb-4">
            <h1 class="text-3xl font-black italic tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 via-orange-500 to-pink-500 uppercase">
                De Grote DD Pub Crawl
            </h1>
            <p class="text-slate-400 text-[10px] font-bold tracking-[0.2em] mt-2 uppercase opacity-80">Wie kotst het eerst?</p>
        </header>

        <!-- Grid View -->
        <div id="view-grid" class="space-y-6">
            <div class="grid grid-cols-2 gap-4" id="pub-grid">
                <!-- Wordt gegenereerd door JS -->
            </div>
        </div>

        <!-- Detail View -->
        <div id="view-detail" class="hidden-view space-y-6 pb-24">
            <button onclick="showGrid()" class="glass px-5 py-2.5 flex items-center gap-2 text-xs font-black text-slate-300 uppercase tracking-wider">
                ‚Üê Terug
            </button>

            <div class="glass p-8 text-center bg-gradient-to-b from-white/5 to-transparent">
                <div id="wildcard-name-input-container" class="hidden mb-4">
                    <label class="block text-[10px] font-black uppercase text-yellow-500 mb-2 tracking-widest">Voer kroegnaam in</label>
                    <input type="text" id="detail-pub-name-input" oninput="updateWildcardName(this.value)" placeholder="Naam van de verrassing..." class="w-full bg-black/40 border border-yellow-500/30 rounded-xl px-4 py-3 text-center text-xl font-black italic uppercase text-white focus:outline-none focus:border-yellow-500 transition">
                </div>
                <h2 id="detail-pub-name" class="text-3xl font-black text-white italic mb-3 uppercase tracking-tight">KROEG NAAM</h2>
                
                <div id="detail-time-box" class="glass px-4 py-2 inline-flex items-center gap-3">
                    <span class="text-yellow-500 font-bold text-xs uppercase">Aankomst</span>
                    <span id="detail-time" class="digital-clock text-xl text-white">--:--</span>
                </div>
            </div>

            <div class="glass p-6 space-y-8">
                <div id="score-container" class="space-y-6"></div>
                <div class="pt-6 border-t border-white/10">
                    <label class="block text-[10px] font-black uppercase text-slate-500 mb-3 tracking-widest">Wildcard Score</label>
                    <input type="text" id="wildcard-comment" placeholder="Wat maakt deze kroeg uniek?" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-4 text-sm focus:outline-none focus:border-yellow-500 transition mb-4 text-white">
                    <div id="wildcard-rating" class="flex justify-center"></div>
                </div>
            </div>

            <div class="glass p-6">
                <h3 class="font-black text-xs uppercase tracking-widest text-slate-500 mb-6 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-pink-500"></span> Drankjes Turven
                </h3>
                <div id="drinks-container" class="space-y-6"></div>
            </div>

            <button onclick="saveCurrentPub()" class="w-full bg-yellow-500 text-black font-black py-5 rounded-2xl shadow-xl uppercase tracking-widest">
                Opslaan & Klaar
            </button>
        </div>
    </main>

    <!-- Result Popup -->
    <div id="score-popup" class="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-6 hidden">
        <div class="glass p-8 max-w-sm w-full text-center popup-scale border-yellow-500/50">
            <div id="score-emoji" class="text-6xl mb-4">üèÜ</div>
            <h3 class="text-yellow-500 font-black uppercase tracking-widest text-xs mb-2">Eindresultaat</h3>
            <h2 id="score-pub-name" class="text-2xl font-black text-white italic uppercase mb-1">KROEG NAAM</h2>
            <div class="my-6">
                <span id="score-value" class="text-7xl font-black italic tracking-tighter text-white">0.0</span>
            </div>
            <p id="score-message" class="text-slate-400 text-sm italic mb-8">Een legendarische score!</p>
            <button onclick="closeScorePopup()" class="w-full bg-white text-black font-black py-4 rounded-xl uppercase tracking-widest text-sm">
                Door naar de volgende
            </button>
        </div>
    </div>

    <!-- Reveal Overlay -->
    <div id="reveal-overlay" class="fixed inset-0 bg-black/95 flex flex-col items-center justify-center z-50 hidden p-6 text-center">
        <div id="reveal-icon" class="text-8xl mb-6">ü•Å</div>
        <h3 id="reveal-subtitle" class="text-sm font-bold text-yellow-500 tracking-widest uppercase mb-2">Moment geduld...</h3>
        <h2 class="text-4xl font-black text-white italic uppercase mb-4" id="reveal-name">Tromgeroffel...</h2>
        
        <!-- Routebeschrijving in Overlay -->
        <div id="reveal-route-box" class="route-box hidden max-w-sm glass p-4 border-blue-500/30 bg-blue-500/10 mb-6">
            <div class="flex items-start gap-3 text-left">
                <span class="text-xl">üìç</span>
                <div>
                    <p id="reveal-address-text" class="text-[10px] font-black text-blue-400 uppercase tracking-tighter mb-1"></p>
                    <p id="reveal-route-text" class="text-[12px] leading-relaxed text-blue-100 font-medium italic"></p>
                </div>
            </div>
        </div>

        <div id="reveal-progress-container" class="mt-12 w-48 h-1 bg-white/10 rounded-full overflow-hidden">
            <div id="reveal-bar" class="h-full bg-yellow-500 transition-all duration-[3s] ease-linear" style="width: 0%"></div>
        </div>

        <button id="close-reveal-btn" onclick="closeReveal()" class="hidden mt-8 px-8 py-3 bg-white text-black font-black uppercase tracking-widest rounded-full">
            Laten we gaan!
        </button>
    </div>

    <script>
        // AUDIO
        const drumrollAudio = new Audio('https://github.com/joris-db/pubcrawl/raw/refs/heads/main/drumroll.mp3'); 
        drumrollAudio.preload = "auto";
        const applauseAudio = new Audio('https://www.soundjay.com/human/sounds/applause-01.mp3');
        applauseAudio.preload = "auto";
        // Gebruik je eigen 'tsja' geluid voor de medium score
        const mediumAudio = new Audio('https://github.com/joris-db/pubcrawl/raw/refs/heads/main/tsja.mp3');
        mediumAudio.preload = "auto";
        const badAudio = new Audio('https://www.soundjay.com/misc/sounds/fail-trombone-01.mp3');
        badAudio.preload = "auto";

        // DATA AMSTERDAM MET GEPERSONALISEERDE ROUTES
        const PUB_DATA = [
            { 
                name: "Bar Shaffy", 
                address: "Nieuwe Vijzelstraat 1",
                icon: "üç∑",
                route: "Zoooo dat is even lekker, hier zijn we al! Hup haal snel een gratis pils op kosten van Ibi!" 
            },
            { 
                name: "Caf√© Eddy Bar", 
                address: "Gerard Doustraat 58",
                icon: "üç∫",
                route: "Verlaat Bar Shaffy en loop de Vijzelgracht af (richting de Pijp). Steek de Stadhouderskade over en ga rechtdoor de Ferdinand Bolstraat in. Sla bij de eerste zijstraat linksaf de Gerard Doustraat in. De Eddy Bar zit na 100 meter aan de rechterkant." 
            },
            { 
                name: "Gambrinus", 
                address: "Ferdinand Bolstraat 180",
                icon: "ü•®",
                route: "Loop de Gerard Doustraat terug naar de Ferdinand Bolstraat en sla linksaf. Loop 5 minuten rechtdoor (voorbij de Albert Cuyp). Gambrinus vind je op de hoek aan je linkerkant." 
            },
            { 
                name: "Chris Scholten", 
                address: "Van Woustraat 104",
                icon: "üçª",
                route: "Loop vanaf Gambrinus over de Ferdinand Bolstraat naar metrostation De Pijp. Sla hier rechtsaf de Ceintuurbaan op en volg deze langs het Sarphatipark tot de kruising met de Van Woustraat. Caf√© Chris Scholten bevindt zich direct op de hoek." 
            },
            { 
                name: "Caf√© de Baron", 
                address: "Tweede Jacob van Campenstraat 150H",
                icon: "üç∏",
                route: "Steek vanaf Chris Scholten de Ceintuurbaan over de Van Woustraat in en neem de eerste zijstraat links, de Tweede Jan Steenstraat. Sla aan het einde van de straat rechtsaf de Eerste Sweelinckstraat op. Loop rechtdoor over de Albert Cuypmarkt tot aan de hoek van de Gerard Doustraat, waar Caf√© de Baron ligt." 
            },
            { 
                name: "WILD CARD", 
                address: "Locatie Onbekend",
                icon: "üé≤",
                route: "De laatste stop bepalen jullie zelf! Zoek een kroeg in de buurt of ga terug naar je favoriet.", 
                isWildcard: true 
            }
        ];

        const PERSON_FACES = ['persoon1.png', 'persoon2.png', 'persoon3.png', 'persoon4.png'];
        const SCORE_CATEGORIES = [
            { id: 'glass', label: 'Glasdikte' },
            { id: 'vibe', label: 'Amusement' },
            { id: 'drinks', label: 'Drankaanbod' },
            { id: 'snacks', label: 'Snackaanbod' },
            { id: 'wow', label: 'Wow factor' }
        ];
        const DRINK_TYPES = [
            { id: 'pils', label: 'Pils', icon: 'üç∫', article: 'Welke' },
            { id: 'speciaal', label: 'Speciaalbier', icon: 'üçª', article: 'Welk' },
            { id: 'wijn', label: 'Wijn', icon: 'üç∑', article: 'Welke' },
            { id: 'cocktail', label: 'Cocktail', icon: 'üç∏', article: 'Welke' },
            { id: 'fris', label: 'Fris', icon: 'ü•§', article: 'Welke' }
        ];

        // STATE
        let state = { pubs: {}, currentPubId: null };
        let db = null;
        let tourDocRef = null;

        function init() {
            try {
                if (typeof __firebase_config !== 'undefined') {
                    const config = JSON.parse(__firebase_config);
                    firebase.initializeApp(config);
                    db = firebase.firestore();
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pubcrawl';
                    tourDocRef = db.doc(`artifacts/${appId}/public/data/tourData/currentTour`);
                    
                    firebase.auth().signInAnonymously().then(() => {
                        tourDocRef.onSnapshot(doc => {
                            if (doc.exists) {
                                state.pubs = doc.data().pubs || {};
                                updateAllCards();
                            }
                        });
                    });
                }
            } catch (e) { console.warn("Firebase fallback"); }
            updateAllCards();
        }

        function updateAllCards() {
            const grid = document.getElementById('pub-grid');
            if(!grid) return;
            grid.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                const pub = state.pubs[i];
                const card = document.createElement('div');
                card.id = `card-${i}`;
                card.onclick = () => handleCardClick(i);
                
                if (pub && pub.revealed) {
                    card.className = "pub-card glass revealed";
                    const displayName = (i === 5 && pub.wildcardName) ? pub.wildcardName : PUB_DATA[i].name;
                    const avg = getAverage(pub);
                    const icon = PUB_DATA[i].icon || "ü•Ç";
                    card.innerHTML = `
                        <div class="text-2xl mb-1">${icon}</div>
                        <h4 class="font-black italic uppercase text-[11px] text-white px-2 leading-tight">${displayName}</h4>
                        <div class="mt-2 px-3 py-1 bg-yellow-500/20 rounded-full border border-yellow-500/30">
                            <span class="text-[9px] font-black text-yellow-500">${avg > 0 ? 'SCORE: ' + avg : 'SCOREN'}</span>
                        </div>
                    `;
                } else {
                    card.className = "pub-card glass";
                    card.innerHTML = `
                        <div class="text-3xl mb-1 opacity-20">?</div>
                        <h4 class="font-black text-[10px] text-slate-500 uppercase tracking-widest">Stop ${i+1}</h4>
                    `;
                }
                grid.appendChild(card);
            }
        }

        function getAverage(pub) {
            if (!pub || !pub.scores) return 0;
            let scores = Object.values(pub.scores).filter(v => v > 0);
            let sum = scores.reduce((a, b) => a + b, 0);
            let count = scores.length;
            if (pub.wildcardScore && pub.wildcardScore > 0) { sum += pub.wildcardScore; count += 1; }
            return count > 0 ? (sum / count).toFixed(1) : 0;
        }

        function handleCardClick(id) {
            if (state.pubs[id] && state.pubs[id].revealed) {
                switchToDetail(id);
            } else {
                startReveal(id);
            }
        }

        function startReveal(id) {
            const overlay = document.getElementById('reveal-overlay');
            const bar = document.getElementById('reveal-bar');
            const name = document.getElementById('reveal-name');
            const icon = document.getElementById('reveal-icon');
            const subtitle = document.getElementById('reveal-subtitle');
            const progressCont = document.getElementById('reveal-progress-container');
            const routeBox = document.getElementById('reveal-route-box');
            const routeText = document.getElementById('reveal-route-text');
            const addressText = document.getElementById('reveal-address-text');
            const closeBtn = document.getElementById('close-reveal-btn');
            
            overlay.classList.remove('hidden');
            routeBox.classList.add('hidden');
            closeBtn.classList.add('hidden');
            progressCont.classList.remove('hidden');
            
            name.innerText = "Spanning stijgt...";
            icon.innerText = "‚è≥";
            subtitle.innerText = "Onze volgende stop wordt...";
            bar.style.transition = 'none';
            bar.style.width = '0%';

            drumrollAudio.currentTime = 0;
            drumrollAudio.play().catch(() => {});

            setTimeout(() => {
                bar.style.transition = 'width 3s linear';
                bar.style.width = '100%';
            }, 50);

            setTimeout(() => {
                drumrollAudio.pause();
                applauseAudio.currentTime = 0;
                applauseAudio.play().catch(() => {});
                
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

                icon.innerText = PUB_DATA[id].icon || "üçª";
                subtitle.innerText = id === 5 ? "DE WILDCARD!" : "BIER HIER!";
                name.innerText = PUB_DATA[id].name;
                
                addressText.innerText = PUB_DATA[id].address;
                routeText.innerText = PUB_DATA[id].route;
                routeBox.classList.remove('hidden');
                progressCont.classList.add('hidden');
                closeBtn.classList.remove('hidden');

                state.pubs[id] = {
                    revealed: true,
                    arrival: null,
                    scores: { glass:0, vibe:0, drinks:0, snacks:0, wow:0 },
                    drinks: {},
                    drinkDetails: {},
                    wildcardScore: 0,
                    wildcardName: id === 5 ? "" : PUB_DATA[id].name
                };
                updateAllCards();
                saveToFirebase();
            }, 3000);
        }

        function closeReveal() {
            document.getElementById('reveal-overlay').classList.add('hidden');
        }

        function switchToDetail(id) {
            state.currentPubId = id;
            if (!state.pubs[id].arrival) {
                state.pubs[id].arrival = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                saveToFirebase();
            }
            document.getElementById('view-grid').classList.add('hidden-view');
            document.getElementById('main-header').classList.add('hidden-view');
            document.getElementById('view-detail').classList.remove('hidden-view');
            renderDetail(id);
            window.scrollTo(0, 0);
        }

        function showGrid() {
            state.currentPubId = null;
            document.getElementById('view-detail').classList.add('hidden-view');
            document.getElementById('view-grid').classList.remove('hidden-view');
            document.getElementById('main-header').classList.remove('hidden-view');
            updateAllCards();
        }

        function renderDetail(id) {
            const pub = state.pubs[id] || {};
            const isWildcard = (id === 5);
            
            const nameEl = document.getElementById('detail-pub-name');
            const inputCont = document.getElementById('wildcard-name-input-container');
            const inputField = document.getElementById('detail-pub-name-input');
            
            if (isWildcard) {
                nameEl.classList.add('hidden');
                inputCont.classList.remove('hidden');
                inputField.value = pub.wildcardName || "";
            } else {
                nameEl.classList.remove('hidden');
                inputCont.classList.add('hidden');
                nameEl.innerText = PUB_DATA[id].name;
            }

            document.getElementById('detail-time').innerText = pub.arrival || '--:--';
            document.getElementById('wildcard-comment').value = pub.wildcardComment || '';

            const scoreCont = document.getElementById('score-container');
            scoreCont.innerHTML = '';
            SCORE_CATEGORIES.forEach((cat, idx) => {
                const div = document.createElement('div');
                const face = PERSON_FACES[(id + idx) % PERSON_FACES.length];
                const currentVal = pub.scores[cat.id] || 0;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-black uppercase text-slate-400">${cat.label}</span>
                        <span class="text-yellow-500 font-bold">${currentVal}</span>
                    </div>
                    <div class="flex justify-between bg-white/5 p-2 rounded-xl">
                        ${[1,2,3,4,5,6,7,8,9,10].map(v => `
                            <img src="${face}" onclick="setScore('${cat.id}', ${v})" 
                                 class="face-rating-img ${v <= currentVal ? 'active' : ''}">
                        `).join('')}
                    </div>
                `;
                scoreCont.appendChild(div);
            });

            const wcFace = PERSON_FACES[(id + 5) % PERSON_FACES.length];
            const wcVal = pub.wildcardScore || 0;
            document.getElementById('wildcard-rating').innerHTML = `
                <div class="flex justify-between bg-white/5 p-2 rounded-xl w-full">
                    ${[1,2,3,4,5,6,7,8,9,10].map(v => `
                        <img src="${wcFace}" onclick="setScore('wildcardScore', ${v})" 
                             class="face-rating-img ${v <= wcVal ? 'active' : ''}">
                    `).join('')}
                </div>
            `;

            const drinkCont = document.getElementById('drinks-container');
            drinkCont.innerHTML = '';
            DRINK_TYPES.forEach(drink => {
                const count = pub.drinks[drink.id] || 0;
                const details = pub.drinkDetails ? (pub.drinkDetails[drink.id] || []) : [];
                const div = document.createElement('div');
                div.className = "space-y-2";
                let inputsHtml = "";
                const article = drink.article || 'Welke';
                for(let i = 0; i < count; i++) {
                    inputsHtml += `<input type="text" placeholder="${article} ${drink.label.toLowerCase()}?" value="${details[i] || ''}" onchange="updateDrinkText('${drink.id}', ${i}, this.value)" class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-xs text-white focus:outline-none focus:border-yellow-500/50">`;
                }
                div.innerHTML = `
                    <div class="flex items-center justify-between glass px-4 py-3">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">${drink.icon}</span>
                            <span class="font-black text-[10px] uppercase">${drink.label}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="setDrink('${drink.id}', -1)" class="w-8 h-8 rounded-lg bg-white/5 border border-white/10">-</button>
                            <span class="font-black text-lg w-6 text-center">${count}</span>
                            <button onclick="setDrink('${drink.id}', 1)" class="w-8 h-8 rounded-lg bg-yellow-500 text-black font-black">+</button>
                        </div>
                    </div>
                    <div class="space-y-1 pl-4">${inputsHtml}</div>
                `;
                drinkCont.appendChild(div);
            });
        }

        function updateWildcardName(val) {
            if (state.currentPubId === 5) {
                state.pubs[5].wildcardName = val;
            }
        }

        function setScore(catId, val) {
            const pub = state.pubs[state.currentPubId];
            if (catId === 'wildcardScore') pub.wildcardScore = val;
            else pub.scores[catId] = val;
            renderDetail(state.currentPubId);
        }

        function setDrink(drinkId, delta) {
            const pub = state.pubs[state.currentPubId];
            if (!pub.drinks) pub.drinks = {};
            if (!pub.drinkDetails) pub.drinkDetails = {};
            const current = pub.drinks[drinkId] || 0;
            const newVal = Math.max(0, current + delta);
            pub.drinks[drinkId] = newVal;
            if (!pub.drinkDetails[drinkId]) pub.drinkDetails[drinkId] = [];
            if (delta > 0) pub.drinkDetails[drinkId].push("");
            else if (delta < 0 && pub.drinkDetails[drinkId].length > 0) pub.drinkDetails[drinkId].pop();
            renderDetail(state.currentPubId);
        }

        function updateDrinkText(drinkId, index, val) {
            state.pubs[state.currentPubId].drinkDetails[drinkId][index] = val;
        }

        function saveCurrentPub() {
            const pub = state.pubs[state.currentPubId];
            pub.wildcardComment = document.getElementById('wildcard-comment').value;
            
            const avg = getAverage(pub);
            showScorePopup(pub, avg);
            
            saveToFirebase();
        }

        function showScorePopup(pub, avg) {
            const popup = document.getElementById('score-popup');
            const nameEl = document.getElementById('score-pub-name');
            const valEl = document.getElementById('score-value');
            const emojiEl = document.getElementById('score-emoji');
            const msgEl = document.getElementById('score-message');
            
            const displayName = (state.currentPubId === 5 && pub.wildcardName) ? pub.wildcardName : PUB_DATA[state.currentPubId].name;
            nameEl.innerText = displayName;
            valEl.innerText = avg;
            
            popup.classList.remove('hidden');
            
            if (avg >= 7) {
                emojiEl.innerText = "üåü";
                msgEl.innerText = "Wauw! Wat een top-kroeg! Hier komen we vaker.";
                applauseAudio.currentTime = 0;
                applauseAudio.play().catch(() => {});
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            } else if (avg >= 5) {
                emojiEl.innerText = "ü§î";
                msgEl.innerText = "Tsja... niet verkeerd, maar ook geen uitschieter.";
                mediumAudio.currentTime = 0;
                mediumAudio.play().catch(() => {});
            } else {
                emojiEl.innerText = "ü§Æ";
                msgEl.innerText = "Oei... snel door naar de volgende stop.";
                badAudio.currentTime = 0;
                badAudio.play().catch(() => {});
            }
        }

        function closeScorePopup() {
            document.getElementById('score-popup').classList.add('hidden');
            showGrid();
        }

        function saveToFirebase() {
            if (tourDocRef) {
                tourDocRef.set({ pubs: state.pubs }, { merge: true });
            }
        }

        window.onload = init;
    </script>
</body>
</html>
